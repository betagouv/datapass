- hosts: datapass-frontend
  tasks:
    - name: deploy frontend
      become: yes
      become_user: "{{ app_user }}"
      script: ./scripts/deploy-dev.sh datapass-frontend
      tags:
        - frontend

- hosts: datapass-backend
  tasks:
    - name: enable altering postgres tables
      become: yes
      become_user: postgres
      command: psql -d datapass -c 'ALTER TABLE "events" DISABLE TRIGGER ALL;ALTER TABLE "users" DISABLE TRIGGER ALL;ALTER TABLE "enrollments" DISABLE TRIGGER ALL;'
      ignore_errors: yes # at first run, these tables may not exist yet
      tags:
        - backend
    - name: deploy backend
      become: yes
      become_user: "{{ app_user }}"
      script: ./scripts/deploy-dev.sh datapass-backend
      tags:
        - backend
    - name: disable altering postgres tables
      become: yes
      become_user: postgres
      command: psql -d datapass -c 'ALTER TABLE "events" ENABLE TRIGGER ALL;ALTER TABLE "users" ENABLE TRIGGER ALL;ALTER TABLE "enrollments" ENABLE TRIGGER ALL;'
      tags:
        - backend

- hosts: api-auth
  tasks:
    - name: deploy api-auth
      become: yes
      become_user: "{{ app_user }}"
      script: ./scripts/deploy-dev.sh api-auth
      tags:
        - api-auth
